<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Delivery Note - Sarura Petroleum</title>
    <style>
        /* ...existing styles... */
        @page {
            size: A4 portrait;
            margin: 0.8cm;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: white;
            overflow-x: hidden;
        }
        .invoice {
            width: 100%;
            padding: 1cm;
            background-color: white;
            position: relative;
            overflow: visible;
            box-sizing: border-box;
        }
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        .watermark img {
            width: 400px;
            opacity: 0.08;
            transform: rotate(-5deg);
            filter: grayscale(100%) contrast(90%);
        }
        /* Add media queries for mobile devices */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 24px;
            }
            .info {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            table, th, td {
                font-size: 0.8em;
            }
            .footer p {
                font-size: 0.7em;
            }
            .invoice {
                box-shadow: none;
            }
        }
        @media print {
            .invoice {
                box-shadow: none;
            }
        }
        /* ...additional existing styles... */
    </style>
    <!-- Include QR code library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Include html2pdf library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="invoice">
        <div class="watermark">
            <img src="logo.jpg" alt="Watermark">
        </div>
        <div class="header">
            <img src="logo.jpg" alt="Left Logo" class="logo logo-left">
            <img src="logo.jpg" alt="Right Logo" class="logo logo-right">
            <h1>DELIVERY NOTE</h1>
            <p>SARURA PETROLEUM LTD</p>
            <p>Dealers in: Petroleum products and transportation.</p>
            <p>KPC SHIPPERS ANNEX ELDORET.</p>
            <p>P. O BOX 7180 -30100 ELDORET (K)</p>
            <p>TEL: +254 708 108227</p>
        </div>
        <div class="info">
            <div>
                <p>DELIVERY NO: <span id="delivery_number"></span></p>
                <p>DATE: <span id="date_issued"></span></p>
            </div>
            <div>
                <p>RECEIVER: <span id="receiver_name"></span></p>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>NO:</th>
                    <th>DESCRIPTION</th>
                    <th>QUANTITY</th>
                    <th>UNIT</th>
                </tr>
            </thead>
            <tbody id="productsTable">
                <!-- Products will be dynamically added here -->
            </tbody>
        </table>
        <div class="footer">
            <p>COUNTRY OF ORIGIN: ELDORET KENYA</p>
            <p>TERM OF SALE: FOT ELDORET</p>
            <div class="verification-section">
                <div class="verification-box">
                    <div class="verification-content">
                        <div class="verification-text">
                            <strong>ELECTRONIC VERIFICATION</strong><br>
                            This delivery note is digitally generated and verified.<br>
                            Authenticity can be confirmed by scanning the QR code.
                        </div>
                        <div class="verification-details">
                            <p>Document ID: <span id="documentRef"></span></p>
                            <p>Generated: <span id="generationTime"></span></p>
                        </div>
                        <div class="qr-box">
                            <div id="qrCode"></div>
                        </div>
                    </div>
                </div>
            </div>
            <p class="validation-text">Thank you for choosing Sarura Petroleum!</p>
        </div>
    </div>

    <script>
        function getDeliveryData() {
            const params = new URLSearchParams(window.location.search);
            const data = {};
            for (const [key, value] of params.entries()) {
                try {
                    data[key] = JSON.parse(decodeURIComponent(value));
                } catch (e) {
                    data[key] = decodeURIComponent(value);
                }
            }
            return data;
        }

        function populateDeliveryNote() {
            const data = getDeliveryData();

            document.getElementById('delivery_number').textContent = data.delivery_number || 'N/A';
            document.getElementById('date_issued').textContent = formatDate(data.date_issued) || 'N/A';
            document.getElementById('receiver_name').textContent = data.receiver_name || 'N/A';

            // Populate products table
            const productsTable = document.getElementById('productsTable');
            productsTable.innerHTML = '';

            const products = Array.isArray(data.products) ? data.products : [];
            products.forEach((product, index) => {
                const row = document.createElement('tr');
                row.classList.add('product-row');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${product.description || 'N/A'}</td>
                    <td>${product.quantity || '0'}</td>
                    <td>${product.unit || 'N/A'}</td>
                `;
                productsTable.appendChild(row);
            });

            if (products.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4">No products available.</td>`;
                productsTable.appendChild(row);
            }

            const verificationId = generateVerificationId(data);
            const verificationUrl = `https://sarurapetroleumltd.com/verify/delivery/${verificationId}`;

            generateQRCode(verificationUrl).then(() => {
                document.getElementById('documentRef').textContent = data.delivery_number || 'N/A';
                document.getElementById('generationTime').textContent = formatDateTime(data.created_at) || 'N/A';

                // Delay before generating PDF to ensure rendering
                setTimeout(downloadPDF, 2000);
            }).catch((error) => {
                console.error("Error generating QR Code:", error);
                setTimeout(downloadPDF, 2000);
            });
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function generateQRCode(url) {
            return new Promise((resolve, reject) => {
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                try {
                    new QRCode(qrContainer, {
                        text: url,
                        width: 100,
                        height: 100,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    setTimeout(resolve, 300);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function generateVerificationId(data) {
            return `SP-DEL-${data.delivery_number}`;
        }

        function downloadPDF() {
            const element = document.querySelector('.invoice');
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'pdf-loading';
            loadingMsg.textContent = 'Generating PDF...';
            document.body.appendChild(loadingMsg);

            // Convert images to base64
            const images = element.getElementsByTagName('img');
            const imagePromises = Array.from(images).map(img => {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const newImg = new Image();
                    newImg.crossOrigin = 'anonymous';
                    newImg.onload = () => {
                        canvas.width = newImg.width;
                        canvas.height = newImg.height;
                        ctx.drawImage(newImg, 0, 0);
                        try {
                            img.src = canvas.toDataURL('image/png');
                        } catch (e) {
                            console.warn('Could not convert image:', e);
                        }
                        resolve();
                    };
                    newImg.onerror = () => {
                        console.warn('Could not load image:', img.src);
                        resolve();
                    };
                    newImg.src = img.src;
                });
            });

            Promise.all(imagePromises)
                .then(() => {
                    const opt = {
                        margin: [10, 10, 10, 10],
                        filename: `Delivery_Note_${document.getElementById('delivery_number').textContent}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: {
                            scale: 2,
                            useCORS: true
                        },
                        jsPDF: {
                            unit: 'mm',
                            format: 'a4',
                            orientation: 'portrait'
                        }
                    };

                    return html2pdf().from(element).set(opt).save();
                })
                .then(() => {
                    document.body.removeChild(loadingMsg);
                })
                .catch(error => {
                    console.error('PDF generation failed:', error);
                    document.body.removeChild(loadingMsg);
                    alert('Failed to generate PDF. Please try again.');
                });
        }

        window.onload = function() {
            populateDeliveryNote();
        }
    </script>
</body>
</html>
