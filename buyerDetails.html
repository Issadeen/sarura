<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Buyer Details - Sarura Petroleum</title>
    <link rel="icon" href="logo.jpg" type="image/jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://kit.fontawesome.com/d00c9b568a.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'custom-light': '#f5f5f5',
                        'custom-dark': '#121212',
                        'custom-accent': '#4ade80',
                        'custom-accent-hover': '#22c55e',
                    }
                }
            }
        }
    </script>
    <style>
        .green-gradient {
            background: linear-gradient(to right, #4ade80, #22c55e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    <!-- Add jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-custom-light dark:bg-custom-dark text-gray-800 dark:text-gray-200">
    <div id="particles-js" class="fixed inset-0 z-0 pointer-events-none opacity-50"></div>

    <!-- Header -->
    <header class="glass-effect sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="dashboard.html" class="flex items-center">
                    <img src="logo.jpg" alt="Sarura Petroleum Logo" class="h-10 w-10 rounded-full border-2 border-custom-accent">
                    <span id="company-name" class="ml-2 text-xl font-bold green-gradient">Sarurapetroleum</span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <button id="toggle-theme" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i class="fas fa-adjust"></i>
                </button>
                <!-- Replace the home icon with a back button -->
                <a href="managebuyer.html" class="back-button">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 relative z-10">

        <!-- Buyer Information -->
        <div class="glass-effect rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Buyer Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <p class="flex items-center">
                    <i class="fas fa-building mr-2 text-custom-accent"></i>
                    Company: <span id="buyer-company" class="ml-2">Loading...</span>
                </p>
                <p class="flex items-center">
                    <i class="fas fa-envelope mr-2 text-custom-accent"></i>
                    Email: <span id="buyer-email" class="ml-2">Loading...</span>
                </p>
                <p class="flex items-center">
                    <i class="fas fa-phone mr-2 text-custom-accent"></i>
                    Phone: <span id="buyer-phone" class="ml-2">Loading...</span>
                </p>
                <p class="flex items-center">
                    <i class="fas fa-user mr-2 text-custom-accent"></i>
                    Contact Person: <span id="buyer-contact" class="ml-2">Loading...</span>
                </p>
                <p class="flex items-center">
                    <i class="fas fa-credit-card mr-2 text-custom-accent"></i>
                    Credit Limit: <span id="buyer-credit" class="ml-2">Loading...</span>
                </p>
                <p class="flex items-center">
                    <i class="fas fa-clock mr-2 text-custom-accent"></i>
                    Payment Terms: <span id="buyer-terms" class="ml-2">Loading...</span>
                </p>
            </div>
        </div>
        


        <!-- Data Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-effect rounded-lg p-6">
                <h3 class="text-xl font-semibold mb-2">All Orders</h3>
                <p id="all-orders-count" class="text-3xl font-bold text-custom-accent">Loading...</p>
            </div>
            <div class="glass-effect rounded-lg p-6">
                <h3 class="text-xl font-semibold mb-2">Pending Orders</h3>
                <p id="pending-orders-count" class="text-3xl font-bold text-custom-accent">Loading...</p>
            </div>
            <div class="glass-effect rounded-lg p-6">
                <h3 class="text-xl font-semibold mb-2">Credit Balance</h3>
                <p id="credit-balance" class="text-3xl font-bold text-custom-accent">Loading...</p>
                <button id="add-credit-btn" class="mt-4 bg-custom-accent hover:bg-custom-accent-hover text-white px-4 py-2 rounded">
                    <i class="fas fa-plus mr-2"></i>Add Credit
                </button>
            </div>
        </div>

        <!-- Add Credit Modal -->
        <div id="add-credit-modal" class="modal">
            <div class="modal-content glass-effect rounded-lg">
                <span class="close-credit">&times;</span>
                <h2 class="text-2xl font-bold mb-4">Add Credit Transaction</h2>
                <form id="add-credit-form" class="space-y-4">
                    <div>
                        <label for="credit-amount" class="block mb-2">Amount</label>
                        <input type="number" id="credit-amount" name="amount" required step="0.001"
                            class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                    </div>
                    <div>
                        <label for="credit-date" class="block mb-2">Date</label>
                        <input type="date" id="credit-date" name="date" required
                            class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                    </div>
                    <div>
                        <label for="bank-name" class="block mb-2">Bank Name</label>
                        <input type="text" id="bank-name" name="bankName" required
                            class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                    </div>
                    <div>
                        <label for="credit-reference" class="block mb-2">Reference Number</label>
                        <input type="text" id="credit-reference" name="reference" required
                            class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                    </div>
                    <button type="submit" 
                            class="bg-custom-accent hover:bg-custom-accent-hover text-white px-6 py-2 rounded transition duration-300">
                        Add Credit
                    </button>
                </form>
            </div>
        </div>

        <!-- Add Credit Transactions Table before the Orders Table -->
        <div class="glass-effect rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Credit Transactions</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-300 dark:border-gray-700">
                            <th class="py-3 text-left">Date</th>
                            <th class="py-3 text-left">Amount</th>
                            <th class="py-3 text-left">Bank</th>
                            <th class="py-3 text-left">Reference</th>
                            <th class="py-3 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="credits-table-body">
                        <!-- Credit rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="glass-effect rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4">Orders List</h2>
            <!-- Add Order Button -->
            <button id="add-order-btn" class="mb-4 bg-custom-accent hover:bg-custom-accent-hover text-white px-4 py-2 rounded">
                <i class="fas fa-plus mr-2"></i>Add Order
            </button>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-300 dark:border-gray-700">
                            <th class="py-3 text-left">Truck Number</th>
                            <th class="py-3 text-left">Product</th>
                            <th class="py-3 text-left">Volume</th>
                            <th class="py-3 text-left">Destination</th>
                            <th class="py-3 text-left">Price</th>
                            <th class="py-3 text-left">Total</th>
                            <th class="py-3 text-left">Credit</th>
                            <th class="py-3 text-left">Debit Balance</th>
                            <th class="py-3 text-left">Status</th>
                            <th class="py-3 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        <!-- Rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Add 'Generate PDF' button -->
        <button id="generate-pdf-btn" class="bg-custom-accent hover:bg-custom-accent-hover text-white px-4 py-2 rounded">
            Generate PDF
        </button>
    </main>

    <!-- Add Order Modal -->
    <div id="add-order-modal" class="modal">
        <div class="modal-content glass-effect rounded-lg">
            <span class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Add New Order</h2>
            <form id="add-order-form" class="space-y-4">
                <div>
                    <label for="truck-number" class="block mb-2">Truck Number</label>
                    <input type="text" id="truck-number" name="truckNumber" required
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="product" class="block mb-2">Product</label>
                    <input type="text" id="product" name="product" required
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="volume" class="block mb-2">Volume</label>
                    <input type="number" id="volume" name="volume" required step="0.001"
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="price" class="block mb-2">Price</label>
                    <input type="number" id="price" name="price" required step="0.001"
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <!-- New Fields -->
                <div>
                    <label for="date" class="block mb-2">Date</label>
                    <input type="date" id="date" name="date" required
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="refno" class="block mb-2">Reference Number</label>
                    <input type="text" id="refno" name="refno" required
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="loCompany" class="block mb-2">LO Company</label>
                    <input type="text" id="loCompany" name="loCompany" required
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="credit" class="block mb-2">Credit</label>
                    <input type="number" id="credit" name="credit" required step="0.001"
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="debitBalance" class="block mb-2">Debit Balance</label>
                    <input type="number" id="debitBalance" name="debitBalance" required step="0.001"
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="destination" class="block mb-2">Destination</label>
                    <input type="text" id="destination" name="destination" required
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="status" class="block mb-2">Order Status</label>
                    <select id="status" name="status" required
                            class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                        <option value="pending">Pending</option>
                        <option value="loaded">Loaded</option>
                    </select>
                </div>
                <button type="submit" 
                        class="bg-custom-accent hover:bg-custom-accent-hover text-white px-6 py-2 rounded transition duration-300">
                    Add Order
                </button>
            </form>
        </div>
    </div>

    <!-- Add Edit Order Modal before the closing body tag -->
    <div id="edit-order-modal" class="modal">
        <div class="modal-content glass-effect rounded-lg">
            <span class="close-edit">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Edit Order</h2>
            <form id="edit-order-form" class="space-y-4">
                <input type="hidden" id="edit-order-id">
                <div>
                    <label for="edit-truck-number" class="block mb-2">Truck Number</label>
                    <input type="text" id="edit-truck-number" name="truckNumber" required
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="edit-product" class="block mb-2">Product</label>
                    <input type="text" id="edit-product" name="product" required
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="edit-volume" class="block mb-2">Volume</label>
                    <input type="number" id="edit-volume" name="volume" required step="0.001"
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="edit-price" class="block mb-2">Price</label>
                    <input type="number" id="edit-price" name="price" required step="0.001"
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="edit-destination" class="block mb-2">Destination</label>
                    <input type="text" id="edit-destination" name="destination" required
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="edit-status" class="block mb-2">Order Status</label>
                    <select id="edit-status" name="status" required
                            class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                        <option value="pending">Pending</option>
                        <option value="loaded">Loaded</option>
                    </select>
                </div>
                <div>
                    <label for="edit-credit" class="block mb-2">Credit</label>
                    <input type="number" id="edit-credit" name="credit" required step="0.001"
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <div>
                    <label for="edit-debit-balance" class="block mb-2">Debit Balance</label>
                    <input type="number" id="edit-debit-balance" name="debitBalance" required step="0.001"
                           class="w-full p-2 rounded bg-white/10 border border-gray-300 dark:border-gray-600">
                </div>
                <button type="submit" 
                        class="bg-custom-accent hover:bg-custom-accent-hover text-white px-6 py-2 rounded transition duration-300">
                    Update Order
                </button>
            </form>
        </div>
    </div>

    <script>
        // Get buyer ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const buyerId = urlParams.get('buyerId');
        let userId;

        // Wait for auth state to be ready before initializing
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                userId = user.uid;
                const companyId = userId;
                initializePage(userId, companyId, buyerId);
            } else {
                window.location.href = 'login.html';
            }
        });

        // References to HTML elements
        let elements = {
            buyerCompanyElem: document.getElementById('buyer-company'),
            buyerEmailElem: document.getElementById('buyer-email'),
            buyerPhoneElem: document.getElementById('buyer-phone'),
            buyerContactElem: document.getElementById('buyer-contact'),
            buyerCreditElem: document.getElementById('buyer-credit'),
            buyerTermsElem: document.getElementById('buyer-terms'),
            allOrdersCountElem: document.getElementById('all-orders-count'),
            pendingOrdersCountElem: document.getElementById('pending-orders-count'),
            ordersTableBody: document.getElementById('orders-table-body'),
            addOrderForm: document.getElementById('add-order-form'),
            addOrderBtn: document.getElementById('add-order-btn'),
            addOrderModal: document.getElementById('add-order-modal'),
            closeModalBtn: document.querySelector('.close'),
            editOrderModal: document.getElementById('edit-order-modal'),
            editOrderForm: document.getElementById('edit-order-form'),
            closeEditBtn: document.querySelector('.close-edit')
        };

        // Add to elements object
        elements.creditBalanceElem = document.getElementById('credit-balance');
        elements.addCreditBtn = document.getElementById('add-credit-btn');
        elements.addCreditModal = document.getElementById('add-credit-modal');
        elements.addCreditForm = document.getElementById('add-credit-form');
        elements.closeCreditBtn = document.querySelector('.close-credit');
        elements.creditsTableBody = document.getElementById('credits-table-body');

        // Helper function to safely update element text content
        function updateElementText(element, text) {
            if (element) {
                // Check if the text should be formatted as a number
                if (typeof text === 'number') {
                    element.textContent = text.toFixed(3);
                } else {
                    // If it's not a number, just display the text as is
                    element.textContent = text || 'N/A';
                }
            } else {
                console.warn(`Element not found while trying to set text: ${text}`);
            }
        }

        // Fetch and display buyer information
        function fetchBuyerInfo(userId, buyerId) {
            db.collection('users').doc(userId).collection('buyers').doc(buyerId)
                .get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        // Don't try to parse these as numbers
                        elements.buyerCompanyElem.textContent = data.companyName || 'N/A';
                        elements.buyerEmailElem.textContent = data.email || 'N/A';
                        elements.buyerPhoneElem.textContent = data.phone || 'N/A';
                        elements.buyerContactElem.textContent = data.contactPerson || 'N/A';
                        // Only format creditLimit as a number
                        elements.buyerCreditElem.textContent = data.creditLimit ? 
                            `${parseFloat(data.creditLimit).toFixed(3)} USD` : 'N/A';
                        elements.buyerTermsElem.textContent = data.paymentTerms || 'N/A';
                        
                        // Update header company name
                        document.getElementById('company-name').textContent = data.companyName || 'Sarura Petroleum';
                    } else {
                        console.log('No buyer document found');
                        Object.values(elements).forEach(elem => {
                            if (elem && typeof elem.textContent !== 'undefined') {
                                elem.textContent = 'No data';
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error("Error fetching buyer info:", error);
                    Object.values(elements).forEach(elem => {
                        if (elem && typeof elem.textContent !== 'undefined') {
                            elem.textContent = 'Error';
                        }
                    });
                });
        }

        // Update the fetchOrdersCount function to use real-time listeners
        function fetchOrdersCount(userId) {
            const buyerId = urlParams.get('buyerId');
            
            // All orders count - real-time listener
            db.collection('users').doc(userId)
                .collection('buyers').doc(buyerId)
                .collection('orders')
                .onSnapshot(snapshot => {
                    updateElementText(elements.allOrdersCountElem, snapshot.size.toString());
                }, error => {
                    console.error("Error fetching all orders count:", error);
                    updateElementText(elements.allOrdersCountElem, 'Error');
                });

            // Pending orders count - real-time listener
            db.collection('users').doc(userId)
                .collection('buyers').doc(buyerId)
                .collection('orders')
                .where('status', '==', 'pending')
                .onSnapshot(snapshot => {
                    updateElementText(elements.pendingOrdersCountElem, snapshot.size.toString());
                }, error => {
                    console.error("Error fetching pending orders count:", error);
                    updateElementText(elements.pendingOrdersCountElem, 'Error');
                });
        }

        // Fetch and display orders in the table
        function fetchAndDisplayOrders(userId) {
            const buyerId = urlParams.get('buyerId');
            db.collection('users').doc(userId)
              .collection('buyers').doc(buyerId)
              .collection('orders')
              .onSnapshot(snapshot => {
                  elements.ordersTableBody.innerHTML = ''; // Clear existing rows
                  snapshot.forEach(doc => {
                      const order = doc.data();
                      const total = parseFloat((order.price * order.volume).toFixed(3));
                      const row = document.createElement('tr');
                      row.innerHTML = `
                          <td>${order.truckNumber}</td>
                          <td>${order.product}</td>
                          <td>${order.volume.toFixed(3)}</td>
                          <td>${order.destination}</td>
                          <td>${order.price.toFixed(3)}</td>
                          <td>${total.toFixed(3)}</td>
                          <td>${order.credit.toFixed(3)}</td>
                          <td>${order.debitBalance.toFixed(3)}</td>
                          <td>${order.status}</td>
                          <td>
                              <button onclick="editOrder('${doc.id}')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2" title="Edit">
                                  <i class="fas fa-edit"></i>
                              </button>
                              <button onclick="deleteOrder('${doc.id}')" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" title="Delete">
                                  <i class="fas fa-trash"></i>
                              </button>
                          </td>
                      `;
                      elements.ordersTableBody.appendChild(row);
                  });
              }, error => {
                  console.error("Error fetching orders:", error);
              });
        }

        // Initialize page by fetching data
        function initializePage(userId, companyId, buyerId) {
            fetchBuyerInfo(userId, buyerId);
            fetchOrdersCount(userId);  // Changed from companyId to userId
            fetchAndDisplayOrders(userId);  // Changed from companyId to userId
            setupFormHandler(userId);  // Changed from companyId to userId
            fetchCreditsAndBalance(userId, buyerId); // Add this line
        }

        // Setup form handler
        function setupFormHandler(userId) {
            elements.addOrderForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const buyerId = urlParams.get('buyerId');
                const price = Number(elements.addOrderForm.price.value);
                const volume = Number(elements.addOrderForm.volume.value);
                const total = parseFloat((price * volume).toFixed(3));
                const newOrder = {
                    truckNumber: elements.addOrderForm.truckNumber.value,
                    product: elements.addOrderForm.product.value,
                    volume: volume,
                    destination: elements.addOrderForm.destination.value,
                    price: price,
                    total: total,
                    date: elements.addOrderForm.date.value,
                    refno: elements.addOrderForm.refno.value,
                    loCompany: elements.addOrderForm.loCompany.value,
                    credit: Number(elements.addOrderForm.credit.value),
                    debitBalance: Number(elements.addOrderForm.debitBalance.value),
                    status: elements.addOrderForm.status.value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                db.collection('users').doc(userId)
                  .collection('buyers').doc(buyerId)
                  .collection('orders')
                  .add(newOrder)
                  .then(() => {
                      elements.addOrderForm.reset();
                      elements.addOrderModal.style.display = "none";
                      alert('Order added successfully!');
                  })
                  .catch(error => {
                      console.error("Error adding order:", error);
                      alert('Failed to add order.');
                  });
            });
        }

        // Edit order function
        function editOrder(orderId) {
            const buyerId = urlParams.get('buyerId');
            if (!firebase.auth().currentUser) return;

            console.log('Editing order:', orderId); // Debug log

            db.collection('users').doc(firebase.auth().currentUser.uid)
                .collection('buyers').doc(buyerId)
                .collection('orders').doc(orderId)
                .get()
                .then(doc => {
                    if (doc.exists) {
                        console.log('Order data:', doc.data()); // Debug log
                        const order = doc.data();
                        
                        // Set form values
                        document.getElementById('edit-order-id').value = orderId;
                        document.getElementById('edit-truck-number').value = order.truckNumber || '';
                        document.getElementById('edit-product').value = order.product || '';
                        document.getElementById('edit-volume').value = order.volume || 0;
                        document.getElementById('edit-price').value = order.price || 0;
                        document.getElementById('edit-destination').value = order.destination || '';
                        document.getElementById('edit-status').value = order.status || 'pending';
                        document.getElementById('edit-credit').value = order.credit || 0;
                        document.getElementById('edit-debit-balance').value = order.debitBalance || 0;
                        
                        // Show modal
                        elements.editOrderModal.style.display = "block";
                    } else {
                        console.log('No order found with ID:', orderId);
                    }
                })
                .catch(error => {
                    console.error("Error fetching order:", error);
                    alert('Failed to load order details.');
                });
        }

        // Delete order function
        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                const user = firebase.auth().currentUser;
                const buyerId = urlParams.get('buyerId');
                if (!user) return;

                db.collection('users').doc(user.uid)
                  .collection('buyers').doc(buyerId)
                  .collection('orders').doc(orderId)
                  .delete()
                  .then(() => {
                      alert('Order deleted successfully!');
                  })
                  .catch(error => {
                      console.error("Error deleting order:", error);
                      alert('Failed to delete order.');
                  });
            }
        }

        // Modal functionality
        elements.addOrderBtn.onclick = function() {
            elements.addOrderModal.style.display = "block";
        }

        elements.closeModalBtn.onclick = function() {
            elements.addOrderModal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == elements.addOrderModal) {
                elements.addOrderModal.style.display = "none";
            }
            if (event.target == elements.editOrderModal) {
                elements.editOrderModal.style.display = "none";
            }
            if (event.target == elements.addCreditModal) {
                elements.addCreditModal.style.display = "none";
            }
        }

        // Add credit modal functionality
        elements.addCreditBtn.onclick = function() {
            elements.addCreditModal.style.display = "block";
        }

        elements.closeCreditBtn.onclick = function() {
            elements.addCreditModal.style.display = "none";
        }

        // Add credit form handler
        elements.addCreditForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const buyerId = urlParams.get('buyerId');
            if (!firebase.auth().currentUser) return;

            const creditTransaction = {
                amount: Number(document.getElementById('credit-amount').value),
                date: document.getElementById('credit-date').value,
                bankName: document.getElementById('bank-name').value,
                reference: document.getElementById('credit-reference').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('users').doc(firebase.auth().currentUser.uid)
                .collection('buyers').doc(buyerId)
                .collection('credits').add(creditTransaction)
                .then(() => {
                    elements.addCreditForm.reset();
                    elements.addCreditModal.style.display = "none";
                    alert('Credit added successfully!');
                })
                .catch(error => {
                    console.error("Error adding credit:", error);
                    alert('Failed to add credit.');
                });
        });

        // Function to fetch and display credits
        function fetchCreditsAndBalance(userId, buyerId) {
            // Listen to credits collection
            db.collection('users').doc(userId)
                .collection('buyers').doc(buyerId)
                .collection('credits')
                .onSnapshot(snapshot => {
                    let totalCredit = 0;
                    elements.creditsTableBody.innerHTML = '';

                    snapshot.forEach(doc => {
                        const credit = doc.data();
                        totalCredit += credit.amount;

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${credit.date}</td>
                            <td>${credit.amount.toFixed(3)}</td>
                            <td>${credit.bankName}</td>
                            <td>${credit.reference}</td>
                            <td>
                                <button onclick="deleteCredit('${doc.id}')" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        elements.creditsTableBody.appendChild(row);
                    });

                    // Calculate total debits (sum of all order debit balances)
                    db.collection('users').doc(userId)
                        .collection('buyers').doc(buyerId)
                        .collection('orders')
                        .get()
                        .then(orderSnapshot => {
                            let totalDebit = 0;
                            orderSnapshot.forEach(doc => {
                                const order = doc.data();
                                totalDebit += order.debitBalance || 0;
                            });

                            // Update credit balance (credit - debit)
                            const balance = totalCredit - totalDebit;
                            elements.creditBalanceElem.textContent = balance.toFixed(3) + ' USD';
                        });
                });
        }

        // Function to delete credit
        function deleteCredit(creditId) {
            if (confirm('Are you sure you want to delete this credit transaction?')) {
                const user = firebase.auth().currentUser;
                const buyerId = urlParams.get('buyerId');
                if (!user) return;

                db.collection('users').doc(user.uid)
                    .collection('buyers').doc(buyerId)
                    .collection('credits').doc(creditId)
                    .delete()
                    .then(() => {
                        alert('Credit transaction deleted successfully!');
                    })
                    .catch(error => {
                        console.error("Error deleting credit:", error);
                        alert('Failed to delete credit transaction.');
                    });
            }
        }

        // Theme toggle functionality with persistence
        // Apply user's theme preference from localStorage
        if (localStorage.getItem('theme') === 'light') {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }

        // Theme toggle functionality with persistence
        const toggleTheme = document.getElementById('toggle-theme');
        toggleTheme.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            // Save theme preference to localStorage
            localStorage.setItem('theme', 
                document.documentElement.classList.contains('dark') ? 'dark' : 'light'
            );
        });

        // Particle.js configuration
        particlesJS("particles-js", {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: "#4ade80" },
                shape: { type: "circle" },
                opacity: { value: 0.5, random: false, anim: { enable: false } },
                size: { value: 3, random: true, anim: { enable: false } },
                line_linked: { enable: true, distance: 150, color: "#4ade80", opacity: 0.4, width: 1 },
                move: { enable: true, speed: 2, direction: "none", random: false, straight: false, out_mode: "out", bounce: false }
            },
            interactivity: {
                detect_on: "canvas",
                events: { onhover: { enable: true, mode: "repulse" }, onclick: { enable: true, mode: "push" }, resize: true },
                modes: { repulse: { distance: 100, duration: 0.4 }, push: { particles_nb: 4 } }
            },
            retina_detect: true
        });

        // Generate PDF functionality
        document.getElementById('generate-pdf-btn').addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });

            // Set colors
            const primaryColor = [74, 222, 128];  // rgb(4ade80) converted
            const textColor = [51, 51, 51];
            const lineColor = [200, 200, 200];

            // Add Sarura logo
            const img = new Image();
            img.src = 'logo.jpg';
            img.onload = function() {
                // Header section
                doc.addImage(img, 'JPEG', 10, 10, 30, 30);
                doc.setFontSize(24);
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.setFont("helvetica", "bold");
                doc.text('Sarura Petroleum', 45, 25);
                
                // Add current date
                doc.setFontSize(10);
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.setFont("helvetica", "normal");
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 250, 20);
                
                // Buyer Information Section
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.text('Buyer Information', 10, 50);
                
                // Add horizontal line under section title
                doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.setLineWidth(0.5);
                doc.line(10, 52, 285, 52);

                // Buyer details in two columns
                doc.setFontSize(11);
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.setFont("helvetica", "normal");
                
                // Left column
                doc.text('Company:', 10, 60);
                doc.text('Email:', 10, 67);
                doc.text('Phone:', 10, 74);
                
                // Right column
                doc.text('Contact Person:', 150, 60);
                doc.text('Credit Limit:', 150, 67);
                doc.text('Payment Terms:', 150, 74);
                
                // Add values in bold
                doc.setFont("helvetica", "bold");
                doc.text(document.getElementById('buyer-company').textContent, 35, 60);
                doc.text(document.getElementById('buyer-email').textContent, 35, 67);
                doc.text(document.getElementById('buyer-phone').textContent, 35, 74);
                doc.text(document.getElementById('buyer-contact').textContent, 185, 60);
                doc.text(document.getElementById('buyer-credit').textContent, 185, 67);
                doc.text(document.getElementById('buyer-terms').textContent, 185, 74);

                // Add Credit/Debit Summary before the orders table
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.text('Financial Summary', 10, 85);
                
                doc.setFontSize(10);
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                
                // Get orders table data first
                const ordersTable = document.getElementById('orders-table-body');
                const rows = ordersTable.getElementsByTagName('tr');
                
                // Calculate total debit and credit
                let totalDebit = 0;
                let totalCredit = 0;
                for (let row of rows) {
                    const cells = row.getElementsByTagName('td');
                    if (cells.length >= 8) {  // Make sure we have enough cells
                        totalDebit += parseFloat(cells[7].textContent) || 0;  // Debit Balance column
                        totalCredit += parseFloat(cells[6].textContent) || 0; // Credit column
                    }
                }
                
                const currentBalance = parseFloat(document.getElementById('credit-balance').textContent);
                
                // Add financial summary
                doc.text(`Total Credits: ${totalCredit.toFixed(3)} USD`, 10, 92);
                doc.text(`Total Debits: ${totalDebit.toFixed(3)} USD`, 100, 92);
                doc.text(`Current Balance: ${currentBalance.toFixed(3)} USD`, 190, 92);
                
                // Orders Table Section - moved down to accommodate summary
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.text('Orders List', 10, 100);
                
                // Add horizontal line under section title
                doc.line(10, 102, 285, 102);

                // Table headers
                const headers = [
                    'Truck Number', 'Product', 'Volume', 'Destination', 
                    'Price', 'Total', 'Credit', 'Debit'
                ];
                
                // Set up table styling
                doc.setFontSize(10);
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.setFont("helvetica", "bold");
                
                // Draw table headers with background
                doc.setFillColor(245, 245, 245);
                doc.rect(10, 105, 275, 7, 'F');
                
                // Add header texts
                let xPos = 10;
                headers.forEach((header, index) => {
                    doc.text(header, xPos, 110);
                    xPos += (index === 0 || index === 3) ? 40 : 35;
                });

                // Table content
                let yPos = 118;

                // Draw table rows
                doc.setFont("helvetica", "normal");
                for (let i = 0; i < rows.length; i++) {
                    const cells = rows[i].getElementsByTagName('td');
                    
                    // Alternate row background
                    if (i % 2 === 1) {
                        doc.setFillColor(250, 250, 250);
                        doc.rect(10, yPos - 5, 275, 7, 'F');
                    }

                    // Add cell data
                    xPos = 10;
                    // Handle each column separately to ensure proper formatting
                    doc.text(cells[0].textContent.toString(), xPos, yPos); // Truck Number
                    xPos += 40;
                    doc.text(cells[1].textContent.toString(), xPos, yPos); // Product
                    xPos += 35;
                    doc.text(parseFloat(cells[2].textContent).toFixed(3), xPos, yPos); // Volume
                    xPos += 35;
                    doc.text(cells[3].textContent.toString(), xPos, yPos); // Destination
                    xPos += 40;
                    doc.text(parseFloat(cells[4].textContent).toFixed(3), xPos, yPos); // Price
                    xPos += 35;
                    doc.text(parseFloat(cells[5].textContent).toFixed(3), xPos, yPos); // Total
                    xPos += 35;
                    doc.text(parseFloat(cells[6].textContent).toFixed(3), xPos, yPos); // Credit
                    xPos += 35;
                    doc.text(parseFloat(cells[7].textContent).toFixed(3), xPos, yPos); // Debit

                    // Add horizontal line
                    doc.setDrawColor(lineColor[0], lineColor[1], lineColor[2]);
                    doc.setLineWidth(0.1);
                    doc.line(10, yPos + 2, 285, yPos + 2);

                    yPos += 8;

                    // Add new page if needed
                    if (yPos > 190) {
                        doc.addPage('', 'landscape');
                        yPos = 20;
                        
                        // Repeat headers on new page
                        doc.setFillColor(245, 245, 245);
                        doc.rect(10, yPos - 5, 275, 7, 'F');
                        xPos = 10;
                        doc.setFont("helvetica", "bold");
                        headers.forEach((header, index) => {
                            doc.text(header, xPos, yPos);
                            xPos += (index === 0 || index === 3) ? 40 : 35;
                        });
                        doc.setFont("helvetica", "normal");
                        yPos += 10;
                    }
                }

                // Add footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Page ${i} of ${pageCount}`, 280, 200, { align: 'right' });
                }

                // Save the PDF
                doc.save('buyer_details.pdf');
            };
        });

        // Add event listeners after elements are defined
        document.addEventListener('DOMContentLoaded', function() {
            // Edit form submit handler
            elements.editOrderForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const user = firebase.auth().currentUser;
                const buyerId = urlParams.get('buyerId');
                const orderId = document.getElementById('edit-order-id').value;

                if (!user) return;

                const updatedOrder = {
                    truckNumber: document.getElementById('edit-truck-number').value,
                    product: document.getElementById('edit-product').value,
                    volume: Number(document.getElementById('edit-volume').value),
                    price: Number(document.getElementById('edit-price').value),
                    destination: document.getElementById('edit-destination').value,
                    status: document.getElementById('edit-status').value,
                    credit: Number(document.getElementById('edit-credit').value),
                    debitBalance: Number(document.getElementById('edit-debit-balance').value),
                    total: Number(document.getElementById('edit-volume').value) * 
                           Number(document.getElementById('edit-price').value),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                console.log('Updating order with:', updatedOrder); // Debug log

                db.collection('users').doc(user.uid)
                    .collection('buyers').doc(buyerId)
                    .collection('orders').doc(orderId)
                    .update(updatedOrder)
                    .then(() => {
                        elements.editOrderModal.style.display = "none";
                        alert('Order updated successfully!');
                    })
                    .catch(error => {
                        console.error("Error updating order:", error);
                        alert('Failed to update order.');
                    });
            });

            // Modal close handlers
            elements.closeEditBtn.onclick = function() {
                elements.editOrderModal.style.display = "none";
            };

            window.onclick = function(event) {
                if (event.target == elements.addOrderModal) {
                    elements.addOrderModal.style.display = "none";
                }
                if (event.target == elements.editOrderModal) {
                    elements.editOrderModal.style.display = "none";
                }
            };
        });


// Move this code block right after the elements declaration
document.addEventListener('DOMContentLoaded', function() {
    // Update elements with credit-related elements
    Object.assign(elements, {
        creditBalanceElem: document.getElementById('credit-balance'),
        addCreditBtn: document.getElementById('add-credit-btn'),
        addCreditModal: document.getElementById('add-credit-modal'),
        addCreditForm: document.getElementById('add-credit-form'),
        closeCreditBtn: document.querySelector('.close-credit'),
        creditsTableBody: document.getElementById('credits-table-body')
    });

    // Add event listeners only after elements are defined
    if (elements.addCreditBtn) {
        elements.addCreditBtn.onclick = function() {
            elements.addCreditModal.style.display = "block";
        };
    }

    if (elements.closeCreditBtn) {
        elements.closeCreditBtn.onclick = function() {
            elements.addCreditModal.style.display = "none";
        };
    }

    // Add event listeners for order modals
    if (elements.addOrderBtn) {
        elements.addOrderBtn.onclick = function() {
            elements.addOrderModal.style.display = "block";
        };
    }

    if (elements.closeModalBtn) {
        elements.closeModalBtn.onclick = function() {
            elements.addOrderModal.style.display = "none";
        };
    }

    // Update window click handler for all modals
    window.onclick = function(event) {
        if (event.target == elements.addOrderModal) {
            elements.addOrderModal.style.display = "none";
        }
        if (event.target == elements.editOrderModal) {
            elements.editOrderModal.style.display = "none";
        }
        if (event.target == elements.addCreditModal) {
            elements.addCreditModal.style.display = "none";
        }
    };
});

// Move credit form submit handler to a separate function
function handleCreditFormSubmit(e) {
    e.preventDefault();
    const buyerId = urlParams.get('buyerId');
    if (!firebase.auth().currentUser) return;

    const creditTransaction = {
        amount: Number(document.getElementById('credit-amount').value),
        date: document.getElementById('credit-date').value,
        bankName: document.getElementById('bank-name').value,
        reference: document.getElementById('credit-reference').value,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    db.collection('users').doc(firebase.auth().currentUser.uid)
        .collection('buyers').doc(buyerId)
        .collection('credits').add(creditTransaction)
        .then(() => {
            elements.addCreditForm.reset();
            elements.addCreditModal.style.display = "none";
            alert('Credit added successfully!');
        })
        .catch(error => {
            console.error("Error adding credit:", error);
            alert('Failed to add credit.');
        });
}

// Update initializePage function to ensure all handlers are set up
function initializePage(userId, companyId, buyerId) {
    fetchBuyerInfo(userId, buyerId);
    fetchOrdersCount(userId);
    fetchAndDisplayOrders(userId);
    setupFormHandler(userId);
    fetchCreditsAndBalance(userId, buyerId);
}

// ...existing code...
</script>
</body>
</html> 