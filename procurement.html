<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procurement - Sarura Petroleum</title>
    <link rel="icon" href="logo.jpg" type="image/jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://kit.fontawesome.com/d00c9b568a.js" crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'custom-light': '#f5f5f5',
                        'custom-dark': '#121212',
                        'custom-accent': '#4ade80',
                        'custom-accent-hover': '#22c55e',
                    }
                }
            }
        }
    </script>
    <style>
        .green-gradient {
            background: linear-gradient(to right, #4ade80, #22c55e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="bg-custom-light dark:bg-custom-dark text-gray-800 dark:text-gray-200 min-h-screen flex flex-col">
    <div id="particles-js" class="fixed inset-0 z-0 pointer-events-none opacity-50"></div>

    <!-- Header -->
    <header class="glass-effect sticky top-0 z-50 border-b border-gray-200 dark:border-gray-700">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="dashboard.html" class="flex items-center">
                    <img src="logo.jpg" alt="Logo" class="h-10 w-10 rounded-full border-2 border-custom-accent">
                    <span class="ml-2 text-xl font-bold green-gradient">SARURA PETROLEUM</span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <button id="toggle-theme" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i class="fas fa-adjust"></i>
                </button>
                <a href="dashboard.html" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i class="fas fa-home"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 relative z-10">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold green-gradient">Buyer Management</h1>
        </div>

        <!-- Management Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- New Buyer Card -->
            <div class="glass-effect rounded-lg p-6 hover:shadow-lg transition-all duration-300 cursor-pointer" 
                 onclick="window.location.href='newbuyer.html'">
                <div class="flex flex-col items-center text-center space-y-4">
                    <div class="w-16 h-16 rounded-full bg-custom-accent flex items-center justify-center">
                        <i class="fas fa-user-plus text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-semibold">New Buyer Account</h3>
                    <p class="text-gray-600 dark:text-gray-400">Create and set up accounts for new buyers</p>
                    <button class="bg-custom-accent hover:bg-custom-accent-hover text-white px-4 py-2 rounded-lg transition-colors duration-300">
                        Create Account
                    </button>
                </div>
            </div>

            <!-- Manage Buyers Card -->
            <div class="glass-effect rounded-lg p-6 hover:shadow-lg transition-all duration-300 cursor-pointer" 
                 onclick="window.location.href='managebuyer.html'">
                <div class="flex flex-col items-center text-center space-y-4">
                    <div class="w-16 h-16 rounded-full bg-custom-accent flex items-center justify-center">
                        <i class="fas fa-users-cog text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-semibold">Manage Buyers</h3>
                    <p class="text-gray-600 dark:text-gray-400">View and manage existing buyer accounts and their reports</p>
                    <button class="bg-custom-accent hover:bg-custom-accent-hover text-white px-4 py-2 rounded-lg transition-colors duration-300">
                        Manage Buyers
                    </button>
                </div>
            </div>

            <!-- General Reports Card -->
            <div class="glass-effect rounded-lg p-6 hover:shadow-lg transition-all duration-300 cursor-pointer" 
                 onclick="window.location.href='generalreports.html'">
                <div class="flex flex-col items-center text-center space-y-4">
                    <div class="w-16 h-16 rounded-full bg-custom-accent flex items-center justify-center">
                        <i class="fas fa-chart-bar text-2xl text-white"></i>
                    </div>
                    <h3 class="text-xl font-semibold">General Reports</h3>
                    <p class="text-gray-600 dark:text-gray-400">Access comprehensive reports and analytics</p>
                    <button class="bg-custom-accent hover:bg-custom-accent-hover text-white px-4 py-2 rounded-lg transition-colors duration-300">
                        View Reports
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Stats Section -->
        <div class="glass-effect rounded-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Quick Overview</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="p-4 rounded-lg bg-opacity-50 bg-white dark:bg-gray-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total Buyers</p>
                            <h3 class="text-2xl font-bold" id="buyersCount">0</h3>
                        </div>
                        <i class="fas fa-users text-3xl text-custom-accent"></i>
                    </div>
                </div>
                <div class="p-4 rounded-lg bg-opacity-50 bg-white dark:bg-gray-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Active Orders</p>
                            <h3 class="text-2xl font-bold" id="pendingOrdersCount">0</h3>
                        </div>
                        <i class="fas fa-shopping-cart text-3xl text-custom-accent"></i>
                    </div>
                </div>
                <div class="p-4 rounded-lg bg-opacity-50 bg-white dark:bg-gray-800">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Monthly Revenue</p>
                            <h3 class="text-2xl font-bold" id="monthlyRevenue">$0</h3>
                        </div>
                        <i class="fas fa-dollar-sign text-3xl text-custom-accent"></i>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- New Order Modal -->
    <div id="newOrderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 text-center">
            <div class="inline-block align-middle bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full p-6">
                <h3 class="text-xl font-bold mb-4 dark:text-white">New Order</h3>
                <form id="newOrderForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Supplier</label>
                        <input type="text" name="supplier" required class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Product</label>
                        <select name="product" required class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="petrol">Petrol</option>
                            <option value="diesel">Diesel</option>
                            <option value="kerosene">Kerosene</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Volume (L)</label>
                            <input type="number" name="volume" required class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Buying Price</label>
                            <input type="number" name="buyingPrice" required class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Buyer</label>
                        <input type="text" name="buyer" required class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Selling Price</label>
                        <input type="number" name="sellingPrice" required class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Truck Number</label>
                        <input type="text" name="truckNumber" required class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeNewOrderModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-custom-accent hover:bg-custom-accent-hover text-white rounded-lg">Save Order</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div id="editOrderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 text-center flex items-center justify-center">
            <div class="inline-block bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full p-6">
                <h3 class="text-xl font-bold mb-4 dark:text-white text-center">Edit Order</h3>
                <form id="editOrderForm" class="space-y-4">
                    <input type="hidden" name="orderId">
                    <div id="pendingFields">
                        <div>
                            <label class="block text-sm font-medium mb-1">Supplier</label>
                            <input type="text" name="supplier" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Product</label>
                            <select name="product" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="petrol">Petrol</option>
                                <option value="diesel">Diesel</option>
                                <option value="kerosene">Kerosene</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Volume (L)</label>
                                <input type="number" name="volume" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Buying Price</label>
                                <input type="number" name="buyingPrice" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Buyer</label>
                            <input type="text" name="buyer" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Selling Price</label>
                            <input type="number" name="sellingPrice" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Truck Number</label>
                            <input type="text" name="truckNumber" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Status</label>
                        <select name="status" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="pending">Pending</option>
                            <option value="loaded">Loaded</option>
                        </select>
                    </div>

                    <div id="vehicleDetails" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Truck Number</label>
                            <input type="text" name="vehicleNumber" readonly class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white bg-gray-100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Driver Name</label>
                            <input type="text" name="driverName" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Loading Time</label>
                            <input type="datetime-local" name="loadingTime" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Loading Location</label>
                            <input type="text" name="loadingLocation" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Destination</label>
                            <input type="text" name="destination" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Notes</label>
                            <textarea name="notes" rows="3" class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-2 mt-4">
                        <button type="button" onclick="closeEditOrderModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-custom-accent hover:bg-custom-accent-hover text-white rounded-lg">Update Order</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Add this new modal -->
    <div id="emailVerificationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 text-center flex items-center justify-center">
            <div class="inline-block bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full p-6">
                <h3 class="text-xl font-bold mb-4 dark:text-white text-center">Email Verification Required</h3>
                <form id="emailVerificationForm" class="space-y-4">
                    <input type="hidden" id="verificationAction">
                    <input type="hidden" id="verificationOrderId">
                    <div>
                        <label class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="verificationEmail" required class="w-full rounded-lg border p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button type="button" onclick="closeEmailVerificationModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-custom-accent hover:bg-custom-accent-hover text-white rounded-lg">Verify</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Add Firebase scripts before config.js and auth.js -->
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script>
        // Initialize Firestore
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        class ProcurementManager {
            constructor() {
                this.db = firebase.firestore();
                this.auth = firebase.auth();
                this.initializeListeners();
                this.orderListener = null; // Add this line
            }

            async initializeListeners() {
                this.auth.onAuthStateChanged(user => {
                    if (user) {
                        this.currentUser = user;
                        // Clean up previous listener if it exists
                        if (this.orderListener) {
                            this.orderListener();
                        }
                        this.listenToOrders();
                    }
                });
            }

            listenToOrders() {
                // Store the listener to be able to detach it later
                this.orderListener = this.db.collection('users')
                    .doc(this.currentUser.uid)
                    .collection('porders')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const orders = [];
                        snapshot.forEach(doc => {
                            orders.push({ id: doc.id, ...doc.data() });
                        });
                        this.updateOrdersTable(orders);
                        this.updateStats(orders); // Pass orders to avoid fetching again
                    }, error => {
                        console.error('Error listening to orders:', error);
                    });
            }

            async updateStats(orders) {
                try {
                    const stats = {
                        pendingOrders: orders.filter(o => o.status === 'pending').length,
                        totalOrders: orders.length,
                        activeBuyers: new Set(orders.map(o => o.buyer)).size,
                        monthlyProfit: orders.reduce((sum, order) => {
                            const orderDate = order.createdAt?.toDate();
                            const now = new Date();
                            const isThisMonth = orderDate && orderDate.getMonth() === now.getMonth() 
                                && orderDate.getFullYear() === now.getFullYear();
                            return sum + (isThisMonth ? this.calculateProfit(order) : 0);
                        }, 0)
                    };

                    document.querySelector('[data-stat="pending-orders"]').textContent = stats.pendingOrders;
                    document.querySelector('[data-stat="total-orders"]').textContent = stats.totalOrders;
                    document.querySelector('[data-stat="active-buyers"]').textContent = stats.activeBuyers;
                    document.querySelector('[data-stat="monthly-profit"]').textContent = 
                        `$${stats.monthlyProfit.toLocaleString()}`;
                } catch (error) {
                    console.error('Error updating stats:', error);
                }
            }

            async addOrder(orderData) {
                try {
                    const order = {
                        ...orderData,
                        userId: this.currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'pending'
                    };

                    await this.db.collection('users')
                        .doc(this.currentUser.uid)
                        .collection('porders')
                        .add(order);

                    // No need to manually update stats; the listener will handle it
                    return true;
                } catch (error) {
                    console.error('Error adding order:', error);
                    throw error;
                }
            }

            updateOrdersTable(orders) {
                const tbody = document.getElementById('ordersTableBody');
                tbody.innerHTML = orders.map(order => `
                    <tr class="border-b border-gray-200 dark:border-gray-700">
                        <td class="py-3 dark:text-gray-200">#${order.id.slice(-6)}</td>
                        <td class="py-3 dark:text-gray-200">${order.company || order.supplier}</td>
                        <td class="py-3 dark:text-gray-200">${order.product}</td>
                        <td class="py-3 dark:text-gray-200">${order.volume.toLocaleString()} L</td>
                        <td class="py-3 dark:text-gray-200">${order.truckNumber || 'N/A'}</td>
                        <td class="py-3">
                            <span class="px-2 py-1 rounded-full text-xs ${
                                order.status === 'pending' ? 
                                'bg-yellow-200 text-yellow-800' : 
                                'bg-green-200 text-green-800'
                            }">${order.status}</span>
                        </td>
                        <td class="py-3 dark:text-gray-200">${order.buyer}</td>
                        <td class="py-3 dark:text-gray-200">$${this.calculateProfit(order).toLocaleString()}</td>
                        <td class="py-3">
                            ${order.status !== 'loaded' ? `
                                <button onclick="procurementManager.editOrder('${order.id}')" 
                                        class="text-blue-500 hover:text-blue-700 mr-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="procurementManager.deleteOrder('${order.id}')" 
                                        class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('');
            }

            calculateProfit(order) {
                return (order.sellingPrice - order.buyingPrice) * order.volume;
            }

            async editOrder(orderId) {
                await this.showEmailVerification('edit', orderId);
            }

            async deleteOrder(orderId) {
                await this.showEmailVerification('delete', orderId);
            }

            async showEmailVerification(action, orderId) {
                try {
                    const modal = document.getElementById('emailVerificationModal');
                    const form = document.getElementById('emailVerificationForm');
                    const actionInput = document.getElementById('verificationAction');
                    const orderInput = document.getElementById('verificationOrderId');

                    if (!modal || !form || !actionInput || !orderInput) {
                        throw new Error('Required modal elements not found');
                    }

                    actionInput.value = action;
                    orderInput.value = orderId;
                    modal.classList.remove('hidden');

                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        const email = document.getElementById('verificationEmail').value;
                        
                        if (await this.verifyUserEmail(email)) {
                            if (action === 'edit') {
                                await this.performEdit(orderId);
                            } else if (action === 'delete') {
                                await this.performDelete(orderId);
                            }
                            closeEmailVerificationModal();
                        } else {
                            alert('Email verification failed');
                        }
                    };
                } catch (error) {
                    console.error('Error in showEmailVerification:', error);
                    alert('An error occurred during verification setup');
                }
            }

            async performEdit(orderId) {
                try {
                    const doc = await this.db.collection('users')
                        .doc(this.currentUser.uid)
                        .collection('porders')
                        .doc(orderId)
                        .get();

                    const order = doc.data();
                    if (order.status === 'loaded') {
                        alert('Cannot edit loaded orders');
                        return;
                    }

                    const form = document.getElementById('editOrderForm');
                    form.orderId.value = orderId;
                    
                    // Populate all fields with existing data
                    form.supplier.value = order.company || order.supplier;
                    form.product.value = order.product;
                    form.volume.value = order.volume;
                    form.buyingPrice.value = order.buyingPrice;
                    form.buyer.value = order.buyer;
                    form.sellingPrice.value = order.sellingPrice;
                    form.truckNumber.value = order.truckNumber;
                    form.status.value = order.status;

                    // Set up status change handler
                    const statusSelect = form.querySelector('select[name="status"]');
                    const pendingFields = document.getElementById('pendingFields');
                    const vehicleDetails = document.getElementById('vehicleDetails');
                    const vehicleNumber = form.querySelector('input[name="vehicleNumber"]');

                    statusSelect.onchange = function(e) {
                        if (e.target.value === 'loaded') {
                            pendingFields.style.display = 'none';
                            vehicleDetails.classList.remove('hidden');
                            vehicleNumber.value = order.truckNumber; // Auto-fill truck number
                        } else {
                            pendingFields.style.display = 'block';
                            vehicleDetails.classList.add('hidden');
                        }
                    };

                    showEditOrderModal();
                } catch (error) {
                    console.error('Error fetching order:', error);
                    alert('Failed to fetch order details');
                }
            }

            async performDelete(orderId) {
                try {
                    const doc = await this.db.collection('users')
                        .doc(this.currentUser.uid)
                        .collection('porders')
                        .doc(orderId)
                        .get();

                    const order = doc.data();
                    if (order.status === 'loaded') {
                        alert('Cannot delete loaded orders');
                        return;
                    }

                    if (confirm('Are you sure you want to delete this order?')) {
                        await this.db.collection('users')
                            .doc(this.currentUser.uid)
                            .collection('porders')
                            .doc(orderId)
                            .delete();
                    }
                } catch (error) {
                    console.error('Error deleting order:', error);
                    alert('Failed to delete order');
                }
            }

            async updateOrder(orderId, orderData, formData) {  // Add formData parameter
                try {
                    if (!this.currentUser) {
                        throw new Error('User not authenticated');
                    }

                    const userDocRef = this.db.collection('users').doc(this.currentUser.uid);
                    const orderRef = userDocRef.collection('porders').doc(orderId);

                    // Get existing order data
                    const orderDoc = await orderRef.get();
                    if (!orderDoc.exists) {
                        throw new Error('Order not found');
                    }

                    const oldData = orderDoc.data();
                    if (oldData.status === 'loaded') {
                        throw new Error('Cannot update loaded orders');
                    }

                    // Create base update data
                    const updateData = {
                        ...oldData,
                        status: orderData.status,
                        company: orderData.company || oldData.company,
                        product: orderData.product,
                        volume: orderData.volume,
                        buyingPrice: orderData.buyingPrice,
                        buyer: orderData.buyer,
                        sellingPrice: orderData.sellingPrice,
                        truckNumber: orderData.truckNumber,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: this.currentUser.email
                    };

                    // Use transaction for data consistency
                    await this.db.runTransaction(async (transaction) => {
                        if (orderData.status === 'loaded') {
                            // Generate unique report ID
                            const reportId = `RPT-${Date.now()}-${orderId}`;
                            const reportRef = userDocRef.collection('userReports').doc(reportId);

                            const reportData = {
                                reportId,
                                orderId,
                                type: 'procurement',
                                supplier: updateData.company || updateData.supplier,
                                product: updateData.product,
                                volume: updateData.volume,
                                buyingPrice: updateData.buyingPrice,
                                sellingPrice: updateData.sellingPrice,
                                profit: this.calculateProfit(updateData),
                                buyer: updateData.buyer,
                                truckNumber: updateData.truckNumber,
                                vehicleDetails: orderData.vehicleDetails,
                                status: 'completed',
                                loadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                createdBy: this.currentUser.email,
                                userId: this.currentUser.uid
                            };

                            // Update order with report reference and vehicle details
                            updateData.reportId = reportId;
                            updateData.reportedAt = firebase.firestore.FieldValue.serverTimestamp();
                            updateData.vehicleDetails = orderData.vehicleDetails;

                            // Save report
                            transaction.set(reportRef, reportData);
                        }

                        // Update the order
                        transaction.update(orderRef, updateData);
                    });

                    console.log('Order updated successfully:', updateData);
                    return true;
                } catch (error) {
                    console.error('Error updating order:', error);
                    throw error;
                }
            }

            redirectToReport(data) {
                // Encode the data as URL parameters
                const params = new URLSearchParams();
                Object.entries(data).forEach(([key, value]) => {
                    params.append(key, value);
                });
                
                // Redirect to addrp.html with the data
                window.location.href = `addrp.html?${params.toString()}&source=procurement`;
            }

            handleError(error, customMessage = 'An error occurred') {
                console.error(error);
                let errorMessage = customMessage;
                
                if (error.code === 'permission-denied') {
                    errorMessage = 'You do not have permission to perform this action';
                } else if (error.code === 'unauthenticated') {
                    errorMessage = 'Please log in to continue';
                    // Redirect to login page
                    window.location.href = '/login.html';
                }
                
                alert(errorMessage);
                return false;
            }

            async verifyUserEmail(email) {
                return email === this.currentUser.email;
            }
        }

        // Initialize procurement manager globally
        window.procurementManager = new ProcurementManager();

        // Update the form submission handler
        document.getElementById('newOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const orderData = {
                company: formData.get('supplier'), // Changed from supplier to company
                product: formData.get('product'),
                volume: parseFloat(formData.get('volume')),
                buyingPrice: parseFloat(formData.get('buyingPrice')),
                sellingPrice: parseFloat(formData.get('sellingPrice')),
                buyer: formData.get('buyer'),
                truckNumber: formData.get('truckNumber'),
                createdAt: new Date()
            };

            try {
                await window.procurementManager.addOrder(orderData);
                closeNewOrderModal();
                e.target.reset();
            } catch (error) {
                console.error('Error adding order:', error);
                alert('Failed to add order. Please try again.');
            }
        });

        // Theme toggle functionality
        const toggleTheme = document.getElementById('toggle-theme');
        toggleTheme.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });

        // Apply saved theme
        if (localStorage.getItem('theme') === 'dark' || 
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        // Initialize particles.js
        particlesJS("particles-js", {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: "#4ade80" },
                shape: { type: "circle" },
                opacity: { value: 0.5, random: false },
                size: { value: 3, random: true },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: "#4ade80",
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 2,
                    direction: "none",
                    random: false,
                    straight: false,
                    out_mode: "out",
                    bounce: false,
                }
            },
            interactivity: {
                detect_on: "canvas",
                events: {
                    onhover: { enable: true, mode: "repulse" },
                    onclick: { enable: true, mode: "push" },
                    resize: true
                },
            },
            retina_detect: true
        });

        // New Order Modal Functions
        function showNewOrderModal() {
            document.getElementById('newOrderModal').classList.remove('hidden');
        }

        function closeNewOrderModal() {
            document.getElementById('newOrderModal').classList.add('hidden');
        }

        // Set theme on load
        document.addEventListener('DOMContentLoaded', (event) => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.classList.toggle('dark', savedTheme === 'dark');
        });

        // Add new functions
        function showEditOrderModal() {
            document.getElementById('editOrderModal').classList.remove('hidden');
        }

        function closeEditOrderModal() {
            document.getElementById('editOrderModal').classList.add('hidden');
        }

        function closeEmailVerificationModal() {
            document.getElementById('emailVerificationModal').classList.add('hidden');
        }

        // Add status change handler
        document.querySelector('select[name="status"]').addEventListener('change', function(e) {
            const vehicleDetails = document.getElementById('vehicleDetails');
            const vehicleInputs = vehicleDetails.querySelectorAll('input:not([readonly])');
            
            if (e.target.value === 'loaded') {
                vehicleDetails.classList.remove('hidden');
                // Add required attribute when fields are visible
                vehicleInputs.forEach(input => input.setAttribute('required', ''));
                
                // Set current date and time as default for loadingTime
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                    .toISOString()
                    .slice(0, 16);
                document.querySelector('input[name="loadingTime"]').value = localDateTime;
            } else {
                vehicleDetails.classList.add('hidden');
                // Remove required attribute when fields are hidden
                vehicleInputs.forEach(input => input.removeAttribute('required'));
            }
        });

        // Update edit form handler
        document.getElementById('editOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const orderId = formData.get('orderId');
            const status = formData.get('status');
            
            try {
                const orderData = {
                    status: status,
                    company: formData.get('supplier'),
                    product: formData.get('product'),
                    volume: parseFloat(formData.get('volume')),
                    buyingPrice: parseFloat(formData.get('buyingPrice')),
                    buyer: formData.get('buyer'),
                    sellingPrice: parseFloat(formData.get('sellingPrice')),
                    truckNumber: formData.get('truckNumber')
                };

                if (status === 'loaded') {
                    // Validate required fields
                    const requiredFields = ['driverName', 'loadingTime', 'loadingLocation', 'destination'];
                    const missingFields = requiredFields.filter(field => !formData.get(field));
                    
                    if (missingFields.length > 0) {
                        throw new Error(`Please fill in all required fields: ${missingFields.join(', ')}`);
                    }

                    orderData.vehicleDetails = {
                        vehicleNumber: formData.get('vehicleNumber'),
                        driverName: formData.get('driverName'),
                        loadingTime: formData.get('loadingTime'),
                        loadingLocation: formData.get('loadingLocation'),
                        destination: formData.get('destination'),
                        notes: formData.get('notes') || '',
                    };
                }

                const result = await window.procurementManager.updateOrder(orderId, orderData, formData);
                if (result) {
                    closeEditOrderModal();
                    if (status === 'loaded') {
                        alert('Order marked as loaded and report generated successfully!');
                    } else {
                        alert('Order updated successfully');
                    }
                    // Force refresh the page to show updated data
                    window.location.reload();
                }
            } catch (error) {
                window.procurementManager.handleError(error, 'Failed to update order');
            }
        });

        // Add new function to update dashboard stats
        async function updateDashboardStats() {
            try {
                const userDoc = firebase.auth().currentUser;
                if (!userDoc) return;

                const buyersSnapshot = await db.collection('users').doc(userDoc.uid).collection('buyers').get();
                const ordersSnapshot = await db.collection('users').doc(userDoc.uid).collection('orders')
                    .where('status', '==', 'active').get();

                document.getElementById('totalBuyers').textContent = buyersSnapshot.size;
                document.getElementById('activeOrders').textContent = ordersSnapshot.size;

                // Calculate monthly revenue
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const revenueSnapshot = await db.collection('users').doc(userDoc.uid).collection('transactions')
                    .where('date', '>=', firstDayOfMonth)
                    .get();

                const totalRevenue = revenueSnapshot.docs.reduce((sum, doc) => sum + doc.data().amount, 0);
                document.getElementById('monthlyRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Call updateDashboardStats when page loads
        document.addEventListener('DOMContentLoaded', () => {
            updateDashboardStats();
        });

        // Update the dashboard stats function
        async function updateDashboardStats() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) return;

                // Get buyers count
                const buyersSnapshot = await db.collection('users').doc(user.uid)
                    .collection('buyers')
                    .get();
                document.getElementById('buyersCount').textContent = buyersSnapshot.size;

                // Get all pending orders across all buyers
                let totalPendingOrders = 0;
                for (const buyerDoc of buyersSnapshot.docs) {
                    const pendingOrdersSnapshot = await db.collection('users').doc(user.uid)
                        .collection('buyers').doc(buyerDoc.id)
                        .collection('orders')
                        .where('status', '==', 'pending')
                        .get();
                    totalPendingOrders += pendingOrdersSnapshot.size;
                }
                document.getElementById('pendingOrdersCount').textContent = totalPendingOrders;

                // Calculate monthly revenue from credits
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                let totalMonthlyRevenue = 0;

                for (const buyerDoc of buyersSnapshot.docs) {
                    const creditsSnapshot = await db.collection('users').doc(user.uid)
                        .collection('buyers').doc(buyerDoc.id)
                        .collection('credits')
                        .where('createdAt', '>=', firstDayOfMonth)
                        .get();

                    creditsSnapshot.forEach(doc => {
                        const credit = doc.data();
                        totalMonthlyRevenue += credit.amount || 0;
                    });
                }

                document.getElementById('monthlyRevenue').textContent = 
                    `$${totalMonthlyRevenue.toLocaleString(undefined, {minimumFractionDigits: 3, maximumFractionDigits: 3})}`;

            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Call updateDashboardStats when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    updateDashboardStats();
                }
            });
        });
    </script>
</body>
</html>  