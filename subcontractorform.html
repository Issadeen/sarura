<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Subcontractor - Sarura Petroleum</title>
    <link rel="icon" href="logo.jpg" type="image/jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .dark .glass {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .green-gradient {
            background: linear-gradient(to right, #4ade80, #22c55e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-header, .glass-footer {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dark .glass-header, .dark .glass-footer {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dark input,
        .dark select {
            background-color: #000;
            color: #fff;
            border-color: #444;
        }

        .dark input::placeholder,
        .dark select::placeholder {
            color: #bbb;
        }

        .spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4ade80;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            z-index: 9999; /* Ensure spinner is above other elements */
            /* Adjust position to cover the whole screen */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner.show {
            display: block;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'custom-light': '#f5f5f5',
                        'custom-dark': '#121212',
                        'custom-accent': '#4ade80',
                        'custom-accent-hover': '#22c55e',
                    }
                }
            }
        }
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
</head>
<body class="bg-custom-light dark:bg-custom-dark text-gray-800 dark:text-gray-200 min-h-screen flex flex-col">
    <div id="particles-js" class="fixed inset-0 z-0 pointer-events-none"></div>
    <div id="spinner" class="spinner"></div> <!-- Add spinner element -->

    <!-- Header -->
    <header class="glass-header fixed w-full top-0 z-50">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center">
                <img src="logo.jpg" alt="Sarura Petroleum Logo" class="h-8 w-8 mr-2 rounded-full border-2 border-custom-accent animate-pulse-slow">
                <h1 class="text-xl font-bold green-gradient">SARURA PETROLEUM</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="toggle-theme" class="text-gray-800 dark:text-gray-200 hover:text-custom-accent transition-colors duration-300">
                    <i class="fas fa-adjust"></i>
                </button>
                <a href="subcontractors.html" class="text-gray-800 dark:text-gray-200 hover:text-custom-accent transition-colors duration-300">
                    <i class="fas fa-times"></i>
                </a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8 relative z-10 pt-20">
        <div class="max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-center green-gradient mb-8">Add New Subcontractor</h2>
            
            <div class="glass-effect rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Bulk Upload</h3>
                <div class="flex items-center justify-between">
                    <div class="space-y-2">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Download the Excel template, fill it with your data, and upload it back.</p>
                        <button onclick="downloadTemplate()" class="btn-primary">
                            <i class="fas fa-download mr-2"></i>Download Template
                        </button>
                    </div>
                    <label class="btn-secondary cursor-pointer">
                        <i class="fas fa-upload mr-2"></i>Upload Excel
                        <input type="file" id="bulkUpload" class="hidden" accept=".xlsx,.xls" onchange="handleBulkUpload(event)">
                    </label>
                </div>
            </div>

            <form id="subcontractorForm" class="glass-effect rounded-lg p-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="entityName">
                                <i class="fas fa-building mr-2 text-custom-accent"></i>Entity Name
                            </label>
                            <input type="text" id="entityName" class="w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700" required placeholder="Enter entity name">
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="prod">
                                <i class="fas fa-box mr-2 text-custom-accent"></i>Product
                            </label>
                            <input type="text" id="prod" class="w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700" required placeholder="Enter product name">
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="transporterName">
                                <i class="fas fa-truck mr-2 text-custom-accent"></i>Transporter Name
                            </label>
                            <input type="text" id="transporterName" class="w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700" required placeholder="Enter transporter name">
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="loadingDate">
                                <i class="fas fa-calendar-day mr-2 text-custom-accent"></i>Loading Date
                            </label>
                            <input type="date" id="loadingDate" class="w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700" required>
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="volProd">
                                <i class="fas fa-gas-pump mr-2 text-custom-accent"></i>Volume Produced (M3)
                            </label>
                            <input type="number" id="volProd" class="w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700" required placeholder="Enter volume produced" step="0.0001">
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="truckDetails">
                                <i class="fas fa-truck-moving mr-2 text-custom-accent"></i>Truck Details
                            </label>
                            <input type="text" id="truckDetails" class="w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700" required placeholder="Enter truck details">
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-6">
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="depot">
                                <i class="fas fa-warehouse mr-2 text-custom-accent"></i>Depot
                            </label>
                            <input type="text" id="depot" class="w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700" required placeholder="Enter depot location">
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="payable">
                                <i class="fas fa-money-check-alt mr-2 text-custom-accent"></i>Payable Amount
                            </label>
                            <input type="number" id="payable" class="w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700" required placeholder="Enter payable amount" step="0.0001">
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="payment">
                                <i class="fas fa-hand-holding-usd mr-2 text-custom-accent"></i>Payment Amount
                            </label>
                            <input type="number" id="payment" class="w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700" required placeholder="Enter payment amount" step="0.0001">
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="cumBalance">
                                <i class="fas fa-balance-scale mr-2 text-custom-accent"></i>Cumulative Balance
                            </label>
                            <input type="number" id="cumBalance" class="w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700 bg-gray-100" readonly placeholder="Automatically calculated" step="0.0001">
                        </div>

                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="status">
                                <i class="fas fa-info-circle mr-2 text-custom-accent"></i>Status
                            </label>
                            <select id="status" class="w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700" required>
                                <option value="offloaded">Offloaded</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Buttons - Full Width -->
                <div class="flex justify-end space-x-4 pt-6 mt-6 border-t dark:border-gray-700">
                    <a href="subcontractors.html" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-300">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </a>
                    <button type="submit" class="px-6 py-2 bg-custom-accent text-white rounded-lg hover:bg-custom-accent-hover transition-colors duration-300">
                        <i class="fas fa-save mr-2"></i>Save Subcontractor
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Add Modal for Missing Data -->
    <div id="missingDataModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-lg">
            <h3 id="missingDataModalTitle" class="text-xl font-semibold mb-4">Fill in Missing Data</h3>
            <form id="missingDataForm">
                <!-- Dynamic form fields will be inserted here -->
                <div id="missingFieldsContainer"></div>
                <div class="flex justify-end space-x-4 mt-4">
                    <button type="button" id="skipRowButton" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Skip</button>
                    <button type="submit" class="px-4 py-2 bg-custom-accent text-white rounded hover:bg-custom-accent-hover">Continue</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="glass-footer py-2 mt-auto">
        <div class="container mx-auto px-4 text-center text-sm text-gray-600 dark:text-gray-400">
            © 2024 Sarura Petroleum
        </div>
    </footer>

    <script>
        // Theme handling
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.classList.toggle('dark', savedTheme === 'dark');

            document.getElementById('toggle-theme').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', 
                    document.documentElement.classList.contains('dark') ? 'dark' : 'light'
                );
            });

            const urlParams = new URLSearchParams(window.location.search);
            const subcontractorId = urlParams.get('id');
            
            if (subcontractorId) {
                document.querySelector('h2').textContent = 'Edit Subcontractor';
                loadSubcontractorData(subcontractorId);
            }

            async function loadSubcontractorData(id) {
                const user = firebase.auth().currentUser;
                if (!user) return;

                try {
                    const doc = await firebase.firestore()
                        .collection('users')
                        .doc(user.uid)
                        .collection('subcontractors')
                        .doc(id)
                        .get();

                    if (doc.exists) {
                        const data = doc.data();
                        for (const [key, value] of Object.entries(data)) {
                            const element = document.getElementById(key);
                            if (element) {
                                if (key === 'loadingDate') {
                                    // Convert timestamp to YYYY-MM-DD format
                                    const date = value.toDate();
                                    element.value = date.toISOString().split('T')[0];
                                } else {
                                    element.value = value;
                                }
                            }
                        }
                        // Ensure balance is calculated after loading data
                        calculateBalance();
                    }
                } catch (error) {
                    console.error('Error loading subcontractor:', error);
                    alert('Error loading subcontractor data');
                }
            }

            document.getElementById('subcontractorForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = firebase.auth().currentUser;
                if (!user) {
                    window.location.href = 'index.html';
                    return;
                }

                const spinner = document.getElementById('spinner');
                spinner.classList.add('show');

                try {
                    const db = firebase.firestore();
                    const batch = db.batch();
                    
                    const loadingDateInput = document.getElementById('loadingDate').value;
                    const loadingDate = loadingDateInput ? new Date(loadingDateInput) : null;
                    const payable = parseFloat(document.getElementById('payable').value) || 0;
                    const payment = parseFloat(document.getElementById('payment').value) || 0;

                    // Save main subcontractor data with payment included
                    const subcontractorData = {
                        entityName: document.getElementById('entityName').value,
                        transporterName: document.getElementById('transporterName').value,
                        prod: document.getElementById('prod').value,
                        loadingDate: loadingDate ? firebase.firestore.Timestamp.fromDate(loadingDate) : null,
                        volProd: parseFloat(document.getElementById('volProd').value) || 0,
                        truckDetails: document.getElementById('truckDetails').value,
                        depot: document.getElementById('depot').value,
                        status: document.getElementById('status').value,
                        payable: payable,
                        payment: payment, // Include initial payment here
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: user.uid,
                        type: 'transport'
                    };

                    // Add subcontractor data to batch
                    const subcontractorRef = db.collection('users')
                        .doc(user.uid)
                        .collection('subcontractors')
                        .doc();
                    batch.set(subcontractorRef, subcontractorData);

                    // Commit batch with retry logic
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            await batch.commit();
                            break;
                        } catch (error) {
                            if (error.code === 'permission-denied' || /ERR_BLOCKED/.test(error.message)) {
                                console.warn('Request blocked, retrying...', error);
                                retries--;
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                continue;
                            }
                            throw error;
                        }
                    }

                    window.location.href = 'subcontractors.html';
                } catch (error) {
                    console.error('Error saving data:', error);
                    alert('Error saving data: ' + error.message);
                } finally {
                    spinner.classList.remove('show');
                }
            });

            // Add listeners for automatic balance calculation
            const payableInput = document.getElementById('payable');
            const paymentInput = document.getElementById('payment');
            const cumBalanceInput = document.getElementById('cumBalance');

            function calculateBalance() {
                const payable = parseFloat(payableInput.value) || 0;
                const payment = parseFloat(paymentInput.value) || 0;
                const balance = payable - payment;
                cumBalanceInput.value = balance.toFixed(2);
            }

            payableInput.addEventListener('input', calculateBalance);
            paymentInput.addEventListener('input', calculateBalance);
        });

        // Add particles.js initialization
        window.addEventListener('load', () => {
            particlesJS('particles-js', {
                particles: {
                    number: { value: 40, density: { enable: true, value_area: 1500 } },
                    color: { value: "#4ade80" },
                    opacity: { value: 0.3 },
                    size: { value: 2 },
                    line_linked: { 
                        enable: true,
                        distance: 150,
                        color: "#4ade80",
                        opacity: 0.2,
                        width: 1
                    },
                    move: { enable: true, speed: 1 }
                },
                interactivity: {
                    detect_on: "canvas",
                    events: {
                        onhover: { enable: true, mode: "repulse" },
                        onclick: { enable: false },
                        resize: true
                    }
                }
            });
        });

        function downloadTemplate() {
            const template = [
                {
                    'Entity Name': '',
                    'Product': '',
                    'Transporter Name': '',
                    'Loading Date': 'YYYY-MM-DD',
                    'Volume (M3)': '',
                    'Truck Details': '',
                    'Depot': '',
                    'Payable Amount': '',
                    'Payment Amount': '',
                    'Cumulative Balance': '', // Added this field
                    'Status': 'offloaded/pending'
                }
            ];

            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "subcontractor_template.xlsx");
        }

        async function handleBulkUpload(event) {
            const spinner = document.getElementById('spinner');
            spinner.classList.add('show');

            try {
                const file = event.target.files[0];
                const data = await readExcelFile(file);
                const user = firebase.auth().currentUser;
                
                if (!user) {
                    alert('Please login first');
                    spinner.classList.remove('show');
                    return;
                }

                let rowIndex = 0;
                const totalRows = data.length;

                // Create a progress element with improved styling
                let progressBar = document.getElementById('progressBar');
                if (!progressBar) {
                    progressBar = document.createElement('div');
                    progressBar.id = 'progressBar';
                    progressBar.style.position = 'fixed';
                    progressBar.style.top = '60%';
                    progressBar.style.left = '50%';
                    progressBar.style.transform = 'translate(-50%, -50%)';
                    progressBar.style.padding = '15px 30px';
                    progressBar.style.borderRadius = '10px';
                    progressBar.style.zIndex = '10000';
                    progressBar.style.fontWeight = 'bold';
                    // Theme-aware styling
                    const isDark = document.documentElement.classList.contains('dark');
                    progressBar.style.backgroundColor = isDark ? '#374151' : '#ffffff';
                    progressBar.style.color = isDark ? '#ffffff' : '#000000';
                    progressBar.style.boxShadow = isDark ? 
                        '0 0 10px rgba(255,255,255,0.1)' : 
                        '0 0 10px rgba(0,0,0,0.2)';
                    document.body.appendChild(progressBar);
                }

                function updateProgress() {
                    const percentage = Math.floor((rowIndex / totalRows) * 100);
                    progressBar.textContent = `Uploading... ${percentage}%`;
                }

                function processNextRow() {
                    if (rowIndex >= data.length) {
                        spinner.classList.remove('show');
                        progressBar.textContent = 'Upload Complete!';
                        setTimeout(() => {
                            document.body.removeChild(progressBar);
                            window.location.href = 'subcontractors.html';
                        }, 1000);
                        return;
                    }

                    const row = data[rowIndex];
                    rowIndex++;
                    updateProgress();

                    // Check if Payment Amount is filled
                    if (row['Payment Amount']) {
                        // Process as payment
                        savePaymentData(row, user).then(() => {
                            processNextRow();
                        }).catch(error => {
                            console.error('Error saving payment:', error);
                            alert('Error saving payment');
                            spinner.classList.remove('show');
                        });
                    } else {
                        // Check for missing required fields
                        const requiredFields = ['Entity Name', 'Product', 'Transporter Name', 'Loading Date', 'Payable Amount'];
                        const missingFields = requiredFields.filter(field => !row[field]);

                        if (missingFields.length > 0) {
                            // Pass rowIndex to showMissingDataModal
                            showMissingDataModal(row, missingFields, user, rowIndex).then(() => {
                                processNextRow();
                            }).catch(error => {
                                console.error('Error processing row:', error);
                                alert('Error processing row');
                                spinner.classList.remove('show');
                            });
                        } else {
                            // All required data is present, process the row
                            saveSubcontractorData(row, user).then(() => {
                                processNextRow();
                            }).catch(error => {
                                console.error('Error saving data:', error);
                                alert('Error saving data');
                                spinner.classList.remove('show');
                            });
                        }
                    }
                }

                processNextRow();

            } catch (error) {
                console.error('Error uploading data:', error);
                alert('Error uploading data: ' + error.message);
                spinner.classList.remove('show');
            }
        }

        function showMissingDataModal(row, missingFields, user, rowNumber) {
            return new Promise((resolve, reject) => {
                const modal = document.getElementById('missingDataModal');
                const missingFieldsContainer = document.getElementById('missingFieldsContainer');

                // Clear previous fields
                missingFieldsContainer.innerHTML = '';

                // Update modal title with row number
                const modalTitle = document.getElementById('missingDataModalTitle');
                modalTitle.textContent = `Fill in Missing Data (Row ${rowNumber})`;

                missingFields.forEach(field => {
                    const fieldId = field.replace(/\s+/g, '');
                    const fieldLabel = document.createElement('label');
                    fieldLabel.textContent = field;
                    fieldLabel.className = 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2';

                    const fieldInput = document.createElement('input');
                    fieldInput.type = field === 'Loading Date' ? 'date' : 'text';
                    fieldInput.id = fieldId;
                    fieldInput.name = field;
                    fieldInput.value = row[field] || ''; // Prefill with existing data
                    fieldInput.className = 'w-full p-3 rounded-lg border transition-all duration-300 dark:bg-black dark:text-white dark:border-gray-700 mb-4';

                    missingFieldsContainer.appendChild(fieldLabel);
                    missingFieldsContainer.appendChild(fieldInput);
                });

                // Show the modal
                modal.classList.remove('hidden');

                const form = document.getElementById('missingDataForm');
                const skipButton = document.getElementById('skipRowButton');

                skipButton.onclick = () => {
                    // Hide the modal and skip this row
                    modal.classList.add('hidden');
                    resolve();
                };

                form.onsubmit = (e) => {
                    e.preventDefault();
                    // Get the filled values
                    missingFields.forEach(field => {
                        const fieldId = field.replace(/\s+/g, '');
                        const value = document.getElementById(fieldId).value;
                        row[field] = value;
                    });
                    // Hide the modal
                    modal.classList.add('hidden');

                    // Re-validate the row
                    const stillMissing = missingFields.filter(field => !row[field]);
                    if (stillMissing.length > 0) {
                        alert('Please fill in all required fields');
                        showMissingDataModal(row, stillMissing, user, rowNumber).then(resolve).catch(reject);
                    } else {
                        // Save the row data
                        saveSubcontractorData(row, user).then(resolve).catch(reject);
                    }
                };
            });
        }

        function saveSubcontractorData(row, user) {
            return new Promise(async (resolve, reject) => {
                try {
                    // Improved date parsing
                    let loadingDate = null;
                    if (row['Loading Date']) {
                        if (row['Loading Date'] instanceof Date) {
                            loadingDate = row['Loading Date'];
                        } else {
                            const parsedDate = new Date(row['Loading Date']);
                            if (!isNaN(parsedDate)) {
                                loadingDate = parsedDate;
                            }
                        }
                    }

                    // Log the date parsing result
                    console.log('Parsed loading date:', loadingDate);

                    const formattedData = {
                        entityName: row['Entity Name']?.trim(),
                        prod: row['Product']?.trim(),
                        transporterName: row['Transporter Name']?.trim(),
                        loadingDate: loadingDate ? firebase.firestore.Timestamp.fromDate(loadingDate) : null,
                        volProd: parseFloat(row['Volume (M3)']) || 0,
                        truckDetails: row['Truck Details']?.trim() || '',
                        depot: row['Depot']?.trim() || '',
                        payable: parseFloat(row['Payable Amount']) || 0,
                        payment: parseFloat(row['Payment Amount']) || 0, // Include payment in same record
                        status: (row['Status']?.toLowerCase()?.trim() || 'pending'),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: user.uid,
                        type: 'transport'
                    };

                    // Validate the formatted data
                    if (!formattedData.entityName || !formattedData.loadingDate) {
                        throw new Error('Missing required fields: Entity Name or Loading Date');
                    }

                    // Log the formatted data
                    console.log('Formatted data for Firebase:', formattedData);

                    const subcontractorsRef = firebase.firestore()
                        .collection('users')
                        .doc(user.uid)
                        .collection('subcontractors');

                    await subcontractorsRef.add(formattedData);
                    resolve();
                } catch (error) {
                    console.error('Error in saveSubcontractorData:', error);
                    reject(error);
                }
            });
        }

        function savePaymentData(row, user) {
            return new Promise(async (resolve, reject) => {
                try {
                    const payment = parseFloat(row['Payment Amount']);
                    if (isNaN(payment)) {
                        reject(new Error('Payment Amount must be a number'));
                        return;
                    }

                    const subcontractorsRef = firebase.firestore()
                        .collection('users')
                        .doc(user.uid)
                        .collection('subcontractors');

                    const querySnapshot = await subcontractorsRef
                        .where('entityName', '==', row['Entity Name'])
                        .get();

                    if (querySnapshot.empty) {
                        alert('No subcontractor found for payment');
                        resolve();
                        return;
                    }

                    const subcontractorDoc = querySnapshot.docs[0];
                    const paymentData = {
                        payment: payment,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    };

                    await subcontractorDoc.ref
                        .collection('payments')
                        .add(paymentData);

                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {
                            type: 'array',
                            cellDates: true,
                            dateNF: 'yyyy-mm-dd'
                        });

                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        // Parse with headers and proper date handling
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            raw: false,
                            dateNF: 'yyyy-mm-dd',
                            header: 1
                        });

                        // Convert array format to object with proper date parsing
                        const headers = jsonData[0];
                        const formattedData = jsonData.slice(1).map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                let value = row[index];
                                
                                // Special handling for dates
                                if (header === 'Loading Date' && value) {
                                    // Try multiple date formats
                                    const possibleDate = new Date(value);
                                    if (!isNaN(possibleDate)) {
                                        value = possibleDate.toISOString().split('T')[0];
                                    } else if (typeof value === 'number') {
                                        // Handle Excel serial date
                                        const excelDate = XLSX.SSF.parse_date_code(value);
                                        value = `${excelDate.y}-${String(excelDate.m).padStart(2, '0')}-${String(excelDate.d).padStart(2, '0')}`;
                                    }
                                }

                                obj[header] = value;
                            });
                            return obj;
                        });

                        // Log the parsed data for verification
                        console.log('Parsed Excel data:', formattedData);
                        resolve(formattedData);
                    } catch (error) {
                        console.error('Excel parsing error:', error);
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>